name: è‡ªåŠ¨æ‰“åŒ…å¹¶å‘å¸ƒ Chrome æ’ä»¶

on:
  push:
    branches: [ main ]
    paths:
      - 'manifest.json'  # åªæœ‰å½“ manifest.json å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¯»å–ç‰ˆæœ¬å·
      id: get_version
      run: |
        VERSION=$(cat manifest.json | jq -r '.version')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "å½“å‰ç‰ˆæœ¬: $VERSION"
        
    - name: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ Release
      id: check_release
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        if gh release view "v$VERSION" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬ v$VERSION çš„ Release ä¸å­˜åœ¨ï¼Œç»§ç»­å‘å¸ƒ"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: åˆ›å»ºæ’ä»¶åŒ…
      if: steps.check_release.outputs.exists == 'false'
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        PACKAGE_NAME="B2Y-YouTube-Bilibili-Danmaku-v$VERSION.zip"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
        mkdir -p temp_package
        
        # å¤åˆ¶éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
        cp -r assets/ temp_package/
        cp -r background/ temp_package/
        cp -r content/ temp_package/
        cp -r lib/ temp_package/
        cp -r utils/ temp_package/
        cp -r popup/ temp_package/
        cp manifest.json temp_package/
        
        # åˆ›å»º zip åŒ…
        cd temp_package
        zip -r "../$PACKAGE_NAME" .
        cd ..
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf temp_package
        
        echo "æ’ä»¶åŒ…å·²åˆ›å»º: $PACKAGE_NAME"
        echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV
        
    - name: åˆ›å»º Release
      if: steps.check_release.outputs.exists == 'false'
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        PACKAGE_NAME="${{ env.package_name }}"
        
        # åˆ›å»º Release
        gh release create "v$VERSION" \
          --title "v$VERSION" \
          --generate-notes \
          "$PACKAGE_NAME"
          
        echo "Release v$VERSION åˆ›å»ºæˆåŠŸ"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è¾“å‡ºç»“æœ
      if: steps.check_release.outputs.exists == 'false'
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        echo "ğŸ‰ Chrome æ’ä»¶ v$VERSION å·²æˆåŠŸæ‰“åŒ…å¹¶å‘å¸ƒåˆ° Release!"
        echo "ğŸ“¦ åŒ…å«æ–‡ä»¶: assets/, background/, content/, lib/, popup/, manifest.json"
        echo "ğŸš« å·²æ’é™¤æ–‡ä»¶: social-config.json, README.md, .git/, .github/"
        
    - name: è·³è¿‡å‘å¸ƒæç¤º  
      if: steps.check_release.outputs.exists == 'true'
      run: |
        VERSION=${{ steps.get_version.outputs.version }}
        echo "â„¹ï¸  ç‰ˆæœ¬ v$VERSION çš„ Release å·²å­˜åœ¨ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒ"