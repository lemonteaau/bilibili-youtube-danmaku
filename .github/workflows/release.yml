name: ğŸš€ WXT å¤šæµè§ˆå™¨æ‰©å±•è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒ

on:
    push:
        branches: [main]
        paths:
            - 'package.json' # ç‰ˆæœ¬å·å˜åŒ–æ—¶è§¦å‘
            - 'wxt.config.js' # WXTé…ç½®å˜åŒ–æ—¶è§¦å‘
            - 'entrypoints/**' # WXTå…¥å£ç‚¹å˜åŒ–æ—¶è§¦å‘
            - 'assets/**' # èµ„æºæ–‡ä»¶å˜åŒ–æ—¶è§¦å‘
            - 'public/**' # å…¬å…±æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘
            - 'background/**' # èƒŒæ™¯è„šæœ¬å˜åŒ–æ—¶è§¦å‘
            - 'content/**' # å†…å®¹è„šæœ¬å˜åŒ–æ—¶è§¦å‘
            - 'popup/**' # å¼¹çª—é¡µé¢å˜åŒ–æ—¶è§¦å‘
            - 'utils/**' # å·¥å…·å‡½æ•°å˜åŒ–æ—¶è§¦å‘
            - 'lib/**' # ç¬¬ä¸‰æ–¹åº“å˜åŒ–æ—¶è§¦å‘
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
        inputs:
            version:
                description: 'å‘å¸ƒç‰ˆæœ¬å· (å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ package.json ä¸­çš„ç‰ˆæœ¬)'
                required: false
                type: string

permissions:
    contents: write
    pull-requests: write

jobs:
    wxt-multi-browser-release:
        runs-on: ubuntu-latest

        steps:
            - name: ğŸ“¥ æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: ğŸ“¦ å®‰è£…ä¾èµ–
              run: |
                  echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
                  npm ci

            - name: ğŸ“‹ è¯»å–ç‰ˆæœ¬å·
              id: get_version
              run: |
                  if [ -n "${{ github.event.inputs.version }}" ]; then
                    VERSION="${{ github.event.inputs.version }}"
                    echo "ğŸ¯ ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„ç‰ˆæœ¬å·: $VERSION"
                  else
                    VERSION=$(node -p "require('./package.json').version")
                    echo "ğŸ“„ ä» package.json è¯»å–ç‰ˆæœ¬å·: $VERSION"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "å½“å‰ç‰ˆæœ¬: $VERSION"

            - name: âœ… éªŒè¯ WXT é…ç½®
              run: |
                  echo "ğŸ” éªŒè¯ WXT é…ç½®å’Œé¡¹ç›®ç»“æ„..."

                  # æ£€æŸ¥ WXT é…ç½®æ–‡ä»¶
                  if [ ! -f "wxt.config.js" ]; then
                    echo "âŒ ç¼ºå°‘ WXT é…ç½®æ–‡ä»¶: wxt.config.js"
                    exit 1
                  fi

                  # æ£€æŸ¥ package.json ä¸­çš„ WXT è„šæœ¬
                  if ! grep -q '"build:' package.json; then
                    echo "âŒ package.json ç¼ºå°‘æ„å»ºè„šæœ¬"
                    exit 1
                  fi

                  # æ£€æŸ¥å…³é”®ç›®å½•
                  REQUIRED_DIRS=("background" "content" "popup" "assets")
                  for dir in "${REQUIRED_DIRS[@]}"; do
                    if [ ! -d "$dir" ]; then
                      echo "âš ï¸  ç¼ºå°‘ç›®å½•: $dir"
                    fi
                  done

                  echo "âœ… WXT é¡¹ç›®ç»“æ„éªŒè¯é€šè¿‡"

            - name: ğŸ” æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
              id: check_release
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="v$VERSION"

                  if gh release view "$TAG_NAME" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "ğŸ“‹ ç‰ˆæœ¬ $TAG_NAME çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "ğŸ†• ç‰ˆæœ¬ $TAG_NAME çš„ Release ä¸å­˜åœ¨ï¼Œç»§ç»­å‘å¸ƒ"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ—ï¸ æ„å»ºå¤šæµè§ˆå™¨æ‰©å±•
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  echo "ğŸ—ï¸ å¼€å§‹æ„å»º v$VERSION å¤šæµè§ˆå™¨æ‰©å±•..."

                  # æ„å»ºæ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬
                  echo "ğŸ“¦ Chrome ç‰ˆæœ¬æ„å»ºä¸­..."
                  npm run build:chrome

                  echo "ğŸ¦Š Firefox ç‰ˆæœ¬æ„å»ºä¸­..."
                  npm run build:firefox

                  echo "ğŸŒŠ Edge ç‰ˆæœ¬æ„å»ºä¸­..."
                  npm run build:edge

                  echo "ğŸ§­ Safari ç‰ˆæœ¬æ„å»ºä¸­..."
                  npm run build:safari

                  echo "âœ… æ‰€æœ‰æµè§ˆå™¨ç‰ˆæœ¬æ„å»ºå®Œæˆ"

            - name: ğŸ“¦ åˆ›å»ºæ‰©å±•åŒ…
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  echo "ğŸ“¦ å¼€å§‹æ‰“åŒ… v$VERSION æ‰©å±•..."

                  # åˆ›å»º ZIP åŒ…
                  echo "ğŸ—œï¸ Chrome ZIP æ‰“åŒ…ä¸­..."
                  npm run zip:chrome

                  echo "ğŸ—œï¸ Firefox ZIP æ‰“åŒ…ä¸­..."
                  npm run zip:firefox

                  echo "ğŸ—œï¸ Edge ZIP æ‰“åŒ…ä¸­..."
                  npm run zip:edge

                  echo "ğŸ—œï¸ Safari ZIP æ‰“åŒ…ä¸­..."
                  npm run zip:safari

                  echo "ğŸ“‹ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
                  ls -la .output/
                  find .output -name "*.zip" -type f -exec ls -lh {} \;

            - name: ğŸ“ å‡†å¤‡å‘å¸ƒèµ„æº
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  echo "ğŸ“ å‡†å¤‡ Release èµ„æºæ–‡ä»¶..."

                  mkdir -p release-assets

                  # æµè§ˆå™¨åˆ—è¡¨å’Œå¯¹åº”çš„emoji
                  declare -A BROWSERS=(
                    ["chrome"]="ğŸŒ"
                    ["firefox"]="ğŸ¦Š"
                    ["edge"]="ğŸŒŠ"
                    ["safari"]="ğŸ§­"
                  )

                  # å¤åˆ¶å¹¶é‡å‘½å ZIP æ–‡ä»¶
                  for browser in "${!BROWSERS[@]}"; do
                    SOURCE_FILE=".output/bilibili-youtube-danmaku-$VERSION-$browser.zip"
                    TARGET_FILE="release-assets/B2Y-YouTube-Bilibili-Danmaku-v$VERSION-$browser.zip"
                    
                    if [ -f "$SOURCE_FILE" ]; then
                      cp "$SOURCE_FILE" "$TARGET_FILE"
                      FILE_SIZE=$(du -h "$TARGET_FILE" | cut -f1)
                      echo "${BROWSERS[$browser]} $browser: $TARGET_FILE ($FILE_SIZE)"
                    else
                      echo "âš ï¸  $browser ç‰ˆæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $SOURCE_FILE"
                    fi
                  done

                  echo ""
                  echo "ğŸ“‹ å‡†å¤‡å®Œæˆçš„å‘å¸ƒèµ„æº:"
                  ls -lah release-assets/

            - name: ğŸ“ ç”Ÿæˆ Release è¯´æ˜
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}

                  cat > release_notes.md << EOF

                  ## ğŸ“¦ ä¸‹è½½å®‰è£…

                  è¯·æ ¹æ®ä½ çš„æµè§ˆå™¨ä¸‹è½½å¯¹åº”çš„æ‰©å±•åŒ…ï¼š

                  ### ğŸŒ Chrome æµè§ˆå™¨
                  1. ä¸‹è½½ **B2Y-YouTube-Bilibili-Danmaku-v$VERSION-chrome.zip**
                  2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
                  3. æ‰“å¼€ \`chrome://extensions/\`
                  4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
                  5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹

                  ### ğŸ¦Š Firefox æµè§ˆå™¨
                  1. ä¸‹è½½ **B2Y-YouTube-Bilibili-Danmaku-v$VERSION-firefox.zip**
                  2. æ‰“å¼€ \`about:debugging\`
                  3. ç‚¹å‡»"æ­¤ Firefox"
                  4. ç‚¹å‡»"ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
                  5. é€‰æ‹©ä¸‹è½½çš„ ZIP æ–‡ä»¶

                  ### ğŸŒŠ Edge æµè§ˆå™¨
                  1. ä¸‹è½½ **B2Y-YouTube-Bilibili-Danmaku-v$VERSION-edge.zip**
                  2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
                  3. æ‰“å¼€ \`edge://extensions/\`
                  4. å¼€å¯"å¼€å‘äººå‘˜æ¨¡å¼"
                  5. ç‚¹å‡»"åŠ è½½è§£å‹ç¼©çš„æ‰©å±•"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹

                  ### ğŸ§­ Safari æµè§ˆå™¨
                  1. ä¸‹è½½ **B2Y-YouTube-Bilibili-Danmaku-v$VERSION-safari.zip**
                  2. æ‰“å¼€ Safari æµè§ˆå™¨ï¼Œè¿›å…¥"å¼€å‘" > "å¼€å‘è€…è®¾ç½®" > "å…è®¸æœªç­¾åçš„æ‹“å±•"
                  3. ç‚¹å‡»"æ·»åŠ ä¸´æ—¶æ‰©å±•"
                  4. é€‰æ‹©ä¸‹è½½çš„ ZIP æ–‡ä»¶
                  5. åœ¨ä½¿ç”¨å‰ç‚¹å‡»æ’ä»¶å›¾æ ‡ï¼Œå…è®¸æ‰©å±•è®¿é—®ç½‘é¡µå†…å®¹(å¦‚æœæç¤º)

                  ## âš ï¸ æ³¨æ„äº‹é¡¹

                  - è¿™æ˜¯ä¸ªäººç»´æŠ¤çš„ Fork ç‰ˆæœ¬ï¼Œä¸ä¼šä¸Šæ¶æµè§ˆå™¨å•†åº—
                  - Firefox ä¸´æ—¶å®‰è£…çš„æ‰©å±•åœ¨æµè§ˆå™¨é‡å¯åä¼šè¢«ç§»é™¤
                  - éœ€è¦æ‰‹åŠ¨å®‰è£…å’Œæ›´æ–°

                  EOF

            - name: ğŸš€ åˆ›å»º GitHub Release
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="v$VERSION"

                  echo "ğŸš€ åˆ›å»º Release: $TAG_NAME"

                  # æ”¶é›†æ‰€æœ‰ ZIP æ–‡ä»¶
                  RELEASE_FILES=""
                  for file in release-assets/*.zip; do
                    if [ -f "$file" ]; then
                      RELEASE_FILES="$RELEASE_FILES $file"
                    fi
                  done

                  if [ -n "$RELEASE_FILES" ]; then
                    # åˆ›å»º Release
                    gh release create "$TAG_NAME" \
                      --title "B2Y v$VERSION - å¤šæµè§ˆå™¨æ”¯æŒ" \
                      --notes-file release_notes.md \
                      --latest \
                      $RELEASE_FILES
                    
                    echo "âœ… Release $TAG_NAME åˆ›å»ºæˆåŠŸï¼"
                  else
                    echo "âŒ æ²¡æœ‰æ‰¾åˆ°å¯å‘å¸ƒçš„ ZIP æ–‡ä»¶"
                    exit 1
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: ğŸ‰ è¾“å‡ºæˆåŠŸä¿¡æ¯
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="v$VERSION"

                  echo ""
                  echo "ğŸ‰ B2Y YouTube Bilibili å¼¹å¹•æ‰©å±• v$VERSION å‘å¸ƒæˆåŠŸï¼"
                  echo ""
                  echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
                  echo "  ğŸ·ï¸  æ ‡ç­¾: $TAG_NAME"
                  echo "  ğŸŒ Chrome: B2Y-YouTube-Bilibili-Danmaku-v$VERSION-chrome.zip"
                  echo "  ğŸ¦Š Firefox: B2Y-YouTube-Bilibili-Danmaku-v$VERSION-firefox.zip"
                  echo "  ğŸŒŠ Edge: B2Y-YouTube-Bilibili-Danmaku-v$VERSION-edge.zip"
                  echo "  ğŸ§­ Safari: B2Y-YouTube-Bilibili-Danmaku-v$VERSION-safari.zip"
                  echo ""
                  echo "ğŸ”— Release é“¾æ¥:"
                  echo "  https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
                  echo ""

            - name: â„¹ï¸ è·³è¿‡å‘å¸ƒæç¤º
              if: steps.check_release.outputs.exists == 'true'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="v$VERSION"
                  echo "â„¹ï¸  ç‰ˆæœ¬ $TAG_NAME çš„ Release å·²å­˜åœ¨ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒ"
                  echo "ğŸ”— ç°æœ‰ Release: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
