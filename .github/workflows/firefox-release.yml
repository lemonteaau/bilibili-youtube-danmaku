name: Firefox æ‰©å±•è‡ªåŠ¨æ‰“åŒ…å‘å¸ƒ

on:
    push:
        branches: [main]
        paths:
            - 'manifest.json' # åªæœ‰å½“ manifest.json å‘ç”Ÿå˜åŒ–æ—¶æ‰è§¦å‘
            - 'lib/browser-api.js' # å½“æ ¸å¿ƒå…¼å®¹æ€§æ–‡ä»¶å˜åŒ–æ—¶è§¦å‘
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
    contents: write
    pull-requests: write

jobs:
    firefox-release:
        runs-on: ubuntu-latest

        steps:
            - name: æ£€å‡ºä»£ç 
              uses: actions/checkout@v4

            - name: è¯»å–ç‰ˆæœ¬å·
              id: get_version
              run: |
                  VERSION=$(cat manifest.json | jq -r '.version')
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "å½“å‰ç‰ˆæœ¬: $VERSION"

            - name: éªŒè¯ Firefox å…¼å®¹æ€§
              run: |
                  echo "ðŸ” éªŒè¯ Firefox å…¼å®¹æ€§é…ç½®..."

                  # æ£€æŸ¥æ˜¯å¦åŒ…å« browser_specific_settings
                  if ! jq -e '.browser_specific_settings.gecko' manifest.json > /dev/null; then
                    echo "âŒ manifest.json ç¼ºå°‘ Firefox å…¼å®¹æ€§é…ç½®"
                    exit 1
                  fi

                  # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ background scripts è€Œéž service_worker
                  if jq -e '.background.service_worker' manifest.json > /dev/null; then
                    echo "âŒ manifest.json ä»ä½¿ç”¨ service_workerï¼Œåº”ä½¿ç”¨ scripts"
                    exit 1
                  fi

                  # æ£€æŸ¥æ˜¯å¦åŒ…å« browser-api.js
                  if [ ! -f "lib/browser-api.js" ]; then
                    echo "âŒ ç¼ºå°‘ Firefox å…¼å®¹æ€§æ–‡ä»¶: lib/browser-api.js"
                    exit 1
                  fi

                  # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ Chrome API è°ƒç”¨
                  if grep -r "chrome\." --include="*.js" . --exclude-dir=.git | grep -v "browser-api.js" | grep -v "browserAPI.*chrome"; then
                    echo "âš ï¸  å‘çŽ°å¯èƒ½çš„ Chrome API è°ƒç”¨ï¼Œè¯·æ£€æŸ¥å…¼å®¹æ€§"
                  fi

                  echo "âœ… Firefox å…¼å®¹æ€§éªŒè¯é€šè¿‡"

            - name: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬çš„ Release
              id: check_release
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="firefox-v$VERSION"
                  if gh release view "$TAG_NAME" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "ç‰ˆæœ¬ $TAG_NAME çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "ç‰ˆæœ¬ $TAG_NAME çš„ Release ä¸å­˜åœ¨ï¼Œç»§ç»­å‘å¸ƒ"
                  fi
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: åˆ›å»º Firefox æ‰©å±•åŒ…
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  PACKAGE_NAME="B2Y-Firefox-v$VERSION.zip"

                  echo "ðŸ“¦ å¼€å§‹æ‰“åŒ… Firefox æ‰©å±•..."

                  # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºŽæ‰“åŒ…
                  mkdir -p temp_package

                  # å¤åˆ¶ Firefox æ‰©å±•éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
                  echo "ðŸ“ å¤åˆ¶æ–‡ä»¶..."
                  cp -r assets/ temp_package/
                  cp -r background/ temp_package/
                  cp -r content/ temp_package/
                  cp -r lib/ temp_package/
                  cp -r utils/ temp_package/
                  cp -r popup/ temp_package/
                  cp manifest.json temp_package/
                  cp channel-associations.json temp_package/
                  cp social-config.json temp_package/
                  cp LICENSE temp_package/

                  # åˆ›å»º Firefox å®‰è£…è¯´æ˜Ž
                  cat > temp_package/FIREFOX_INSTALL.txt << 'EOF'
                  B2Y Firefox æ‰©å±•å®‰è£…è¯´æ˜Ž
                  ========================

                  æ–¹æ³•ä¸€ï¼šä¸´æ—¶å®‰è£…ï¼ˆæŽ¨èç”¨äºŽæµ‹è¯•ï¼‰
                  1. åœ¨ Firefox ä¸­æ‰“å¼€ about:debugging
                  2. ç‚¹å‡»"æ­¤ Firefox"
                  3. ç‚¹å‡»"ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
                  4. é€‰æ‹©è§£åŽ‹åŽçš„ manifest.json æ–‡ä»¶

                  æ–¹æ³•äºŒï¼šå¼€å‘è€…æ¨¡å¼å®‰è£…ï¼ˆæ°¸ä¹…å®‰è£…ï¼‰
                  1. åœ¨ Firefox ä¸­æ‰“å¼€ about:config
                  2. æœç´¢ xpinstall.signatures.required
                  3. å°†å€¼è®¾ç½®ä¸º falseï¼ˆæ³¨æ„ï¼šè¿™ä¼šé™ä½Žå®‰å…¨æ€§ï¼‰
                  4. é‡å¯ Firefox
                  5. çŽ°åœ¨å¯ä»¥ç›´æŽ¥å®‰è£… .xpi æ–‡ä»¶

                  æŠ€æœ¯è¦æ±‚ï¼š
                  - Firefox 109 æˆ–æ›´é«˜ç‰ˆæœ¬
                  - æ”¯æŒ WebExtensions Manifest V3

                  é¡¹ç›®åœ°å€ï¼šhttps://github.com/lemonteaau/bilibili-youtube-danmaku
                  EOF

                  # åˆ›å»º ZIP åŒ…
                  echo "ðŸ—œï¸  åˆ›å»º ZIP åŒ…..."
                  cd temp_package
                  zip -r "../$PACKAGE_NAME" . -x "*.DS_Store" "*/.DS_Store"
                  cd ..

                  # æ¸…ç†ä¸´æ—¶ç›®å½•
                  rm -rf temp_package

                  # è®¡ç®—æ–‡ä»¶å¤§å°
                  ZIP_SIZE=$(du -h "$PACKAGE_NAME" | cut -f1)

                  echo "âœ… Firefox æ‰©å±•åŒ…åˆ›å»ºå®Œæˆ:"
                  echo "  ðŸ“¦ ZIP åŒ…: $PACKAGE_NAME ($ZIP_SIZE)"

                  # è®¾ç½®çŽ¯å¢ƒå˜é‡
                  echo "package_name=$PACKAGE_NAME" >> $GITHUB_ENV

            - name: ç”Ÿæˆ Release è¯´æ˜Ž
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}

                  cat > release_notes.md << 'EOF'
                  # ðŸ¦Š B2Y Firefox æ‰©å±• v$VERSION

                  è¿™æ˜¯ä¸“ä¸º Firefox æµè§ˆå™¨ä¼˜åŒ–çš„ B2Y æ‰©å±•ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ YouTube ä¸ŠåŒæ­¥æ˜¾ç¤º Bilibili å¼¹å¹•ã€‚

                  ## ðŸ“¦ å®‰è£…æ–¹å¼

                  ä¸‹è½½ **B2Y-Firefox-v$VERSION.zip** æ–‡ä»¶ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å®‰è£…ï¼š

                  ## ðŸš€ å®‰è£…æ­¥éª¤

                  1. ä¸‹è½½ä¸Šæ–¹çš„ **`.zip`** æ–‡ä»¶å¹¶è§£åŽ‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
                  2. æ‰“å¼€ Firefox æµè§ˆå™¨
                  3. åœ¨åœ°å€æ è¾“å…¥ `about:debugging`
                  4. ç‚¹å‡»å·¦ä¾§çš„ "æ­¤ Firefox"
                  5. ç‚¹å‡» "ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶"
                  6. é€‰æ‹©è§£åŽ‹åŽæ–‡ä»¶å¤¹ä¸­çš„ `manifest.json` æ–‡ä»¶
                  7. æ‰©å±•å®‰è£…å®Œæˆï¼

                  ## âš ï¸  æ³¨æ„äº‹é¡¹

                  - æœ¬ç‰ˆæœ¬ä¸“ä¸º Firefox ä¼˜åŒ–ï¼Œä¸å†ç»´æŠ¤ Chrome å…¼å®¹æ€§
                  - éœ€è¦ Firefox 109 æˆ–æ›´é«˜ç‰ˆæœ¬
                  - ä¸´æ—¶å®‰è£…çš„æ‰©å±•åœ¨æµè§ˆå™¨é‡å¯åŽä¼šè¢«ç§»é™¤

                  EOF

                  # æ›¿æ¢ç‰ˆæœ¬å·
                  sed -i "s/\$VERSION/$VERSION/g" release_notes.md

            - name: åˆ›å»º Firefox Release
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="firefox-v$VERSION"
                  PACKAGE_NAME="B2Y-Firefox-v$VERSION.zip"

                  echo "ðŸš€ åˆ›å»º Firefox Release: $TAG_NAME"

                  # åˆ›å»º Release
                  gh release create "$TAG_NAME" \
                    --title "ðŸ¦Š B2Y Firefox v$VERSION" \
                    --notes-file release_notes.md \
                    --latest \
                    "$PACKAGE_NAME"
                    
                  echo "âœ… Firefox Release $TAG_NAME åˆ›å»ºæˆåŠŸ"
                  echo "ðŸ“¦ å·²ä¸Šä¼ æ–‡ä»¶:"
                  echo "  - $PACKAGE_NAME (ZIP æ ¼å¼)"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: è¾“å‡ºæˆåŠŸä¿¡æ¯
              if: steps.check_release.outputs.exists == 'false'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="firefox-v$VERSION"

                  echo "ðŸŽ‰ Firefox æ‰©å±• v$VERSION å·²æˆåŠŸæ‰“åŒ…å¹¶å‘å¸ƒ!"
                  echo ""
                  echo "ðŸ“‹ å‘å¸ƒä¿¡æ¯:"
                  echo "  ðŸ·ï¸  æ ‡ç­¾: $TAG_NAME"
                  echo "  ðŸ“¦ ZIP åŒ…: B2Y-Firefox-v$VERSION.zip"
                  echo ""
                  echo "ðŸ”— Release é“¾æŽ¥:"
                  echo "  https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
                  echo ""
                  echo "ðŸ“¥ ç”¨æˆ·å®‰è£…æ–¹å¼:"
                  echo "  1. ä¸‹è½½ ZIP åŒ…å¹¶è§£åŽ‹"
                  echo "  2. Firefox ä¸­æ‰“å¼€ about:debugging"
                  echo "  3. ä¸´æ—¶è½½å…¥é™„åŠ ç»„ä»¶ï¼Œé€‰æ‹© manifest.json"

            - name: è·³è¿‡å‘å¸ƒæç¤º
              if: steps.check_release.outputs.exists == 'true'
              run: |
                  VERSION=${{ steps.get_version.outputs.version }}
                  TAG_NAME="firefox-v$VERSION"
                  echo "â„¹ï¸  ç‰ˆæœ¬ $TAG_NAME çš„ Release å·²å­˜åœ¨ï¼Œæœ¬æ¬¡è·³è¿‡å‘å¸ƒ"
                  echo "ðŸ”— çŽ°æœ‰ Release: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
